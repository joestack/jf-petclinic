name: "jf-petclinic-build"
on:
  pull_request_target:
    types: [opened, synchronize]
  push: # Triggers scan-repo flow for every push to the specified branches
    branches:
      - main
      - develop

permissions:
  pull-requests: write
  contents: read
  id-token: write
  actions: read
  security-events: write

jobs:
  build-and-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        #with:
        #  ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ vars.JF_URL }}
        with:
          oidc-provider-name: joestack/jf-petclinic@github

      - name: Run JFrog CLI
        run: |
          # Ping the server
          jf rt ping
          jf c show
 
      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '25'
          #cache: maven
 
      - name: Source Code Scan
        run: |
          jf audit --gradle --sast --sca --secrets --sbom --format=table > audit-results

      - name: Upload Audit results
        uses: actions/upload-artifact@v4
        with:
          name: audit-results
          path: audit-results

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
 
      - name: Gradle Build
        run: |
          jf gradlec \
            --repo-deploy=jf-petclinic-gradle-release-local \
            --repo-resolve=jf-petclinic-gradle-release
          # Build steps here
          # jf gradle clean build test
          jf gradle clean build test artifactoryPublish


      - name: Publish Build Info
        run: |
          jf rt build-add-git # connect to git metadata and repo
          jf rt build-collect-env # show ENV variables
          jf rt build-publish

      - name: Scan Build with Xray Watches
        id: xray-scan
        run: |
          jf bs \
             --fail=true \
             --format=json > scan-results.json
          
          # # Scan-Status auswerten
          # cat scan-results.json
          
          # # Bei kritischen Vulnerabilities fehlschlagen
          # CRITICAL_COUNT=$(jq '.summary.total_critical // 0' scan-results.json)
          # HIGH_COUNT=$(jq '.summary.total_high // 0' scan-results.json)
          
          # if [ "$CRITICAL_COUNT" -gt 0 ]; then
          #   echo "âŒ Found $CRITICAL_COUNT critical vulnerabilities!"
          #   exit 1
          # fi
          
          # if [ "$HIGH_COUNT" -gt 5 ]; then
          #   echo "âš ï¸ Found $HIGH_COUNT high vulnerabilities (threshold: 5)"
          #   exit 1
          # fi
          
          # echo "âœ… Security scan passed"
      
      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xray-scan-results
          path: scan-results.json
      
      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('scan-results.json', 'utf8'));
            
            const comment = `## ðŸ” JFrog Xray Security Scan Results
            
            **Build:** ${context.repo.repo}/${context.runNumber}
            
            ### Summary
            - ðŸ”´ Critical: ${results.summary.total_critical || 0}
            - ðŸŸ  High: ${results.summary.total_high || 0}
            - ðŸŸ¡ Medium: ${results.summary.total_medium || 0}
            - ðŸŸ¢ Low: ${results.summary.total_low || 0}
            
            ${results.summary.total_critical > 0 ? 'âš ï¸ **Action Required:** Critical vulnerabilities found!' : 'âœ… No critical issues found'}
            
            [View full report in JFrog Platform](${process.env.JF_URL})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });











      # - name: Build Tag and push Docker Image
      #   env:
      #     IMAGE_NAME: joefrog.jfrog.io/jf-petclinic-docker/petclinic-image:${{ github.run_number }}
      #   run: |
      #     jf docker build -t $IMAGE_NAME .
      #     jf docker push $IMAGE_NAME    

      # - name: Scan Docker Image
      #   env:
      #     IMAGE_NAME: joefrog.jfrog.io/jf-petclinic-docker/petclinic-image:${{ github.run_number }}
      #   run: |
      #     # FÃ¼hre Xray Scan durch und speichere Ergebnisse als JSON
      #     jf docker scan $IMAGE_NAME --format=json > xray-results.json
      
      # - name: Upload scan results
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: xray-scan-results
      #     path: xray-results.json

      # - name: Publish Build Info
      #   run: |
      #     # Collect Build-Info
      #     jf rt build-add-git # connect to git metadata and repo
      #     jf rt build-collect-env # show ENV variables
      #     jf rt build-publish # push info to rt 

      # - name: Scan Build with Xray
      #   run: |
      #     jf build-scan # Build Info: Security

      # - name: Run Frogbot
      #   uses: jfrog/frogbot@v2
      #   env:
      #     #JFROG_CLI_LOG_LEVEL: DEBUG
      #     JF_URL: ${{ vars.JF_URL }}
      #     JF_ACCESS_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}
      #     JF_GIT_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     JF_GIT_PROVIDER: github
      #     JF_GIT_OWNER: ${{ github.repository_owner }}
      #     JF_GIT_REPO: ${{ github.event.repository.name }}
      #     JF_GIT_PULL_REQUEST_ID: ${{ github.event.pull_request.number }}
      #     #JF_INCLUDE_ALL_VULNERABILITIES: "TRUE"
      #     #JF_WATCHES: "w-critical"
        
      # - name: Generate Job Summary
      #   run: |
      #     jf gsm
      #   continue-on-error: true